<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nina Fashion</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Firebase v10 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, set, get, push, remove, update, onValue, increment } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAfgVsMgExh9AERSJWwIt2j0QA1uvvQLRw",
            authDomain: "ninafashion-78a49.firebaseapp.com",
            databaseURL: "https://ninafashion-78a49-default-rtdb.firebaseio.com",
            projectId: "ninafashion-78a49",
            storageBucket: "ninafashion-78a49.appspot.com",
            messagingSenderId: "597427065874",
            appId: "1:597427065874:web:24b3256adbf3ea7541b4cb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        window.db = db;
        window.storage = storage;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbGet = get;
        window.dbPush = push;
        window.dbRemove = remove;
        window.dbUpdate = update;
        window.dbOnValue = onValue;
        window.dbIncrement = increment;
        window.storageRef = storageRef;
        window.storageUpload = uploadBytes;
        window.storageGetURL = getDownloadURL;
        window.firebaseReady = true;

        // Demo data
        const productsRef = ref(db, 'products');
        const categoriesRef = ref(db, 'categories');

        get(productsRef).then(snap => {
            if (!snap.exists()) {
                set(productsRef, {
                    'ST001': {
                        code: 'ST-001',
                        name_uz: 'PIRAMIDA',
                        name_ru: '–ü–ò–†–ê–ú–ò–î–ê',
                        material_uz: 'MARKIZA',
                        material_ru: '–ú–ê–†–ö–ò–ó–ê',
                        desc_uz: 'Yuqori sifatli Markiza materialidan tayyorlangan zamonaviy model.',
                        desc_ru: '–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –∏–∑ –≤—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –º–∞—Ä–∫–∏–∑–æ–≤–æ–π —Ç–∫–∞–Ω–∏.',
                        category: 'populyar',
                        image: '',
                        sizes: '42,44,46,48',
                        views: 0,
                        likes: 0,
                        createdAt: Date.now()
                    }
                });
            }
        });

        get(categoriesRef).then(snap => {
            if (!snap.exists()) {
                set(categoriesRef, {
                    populyar: { name_uz: 'Populyar', name_ru: '–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ' },
                    premium: { name_uz: 'Premium', name_ru: '–ü—Ä–µ–º–∏—É–º' },
                    klassik: { name_uz: 'Klassik', name_ru: '–ö–ª–∞—Å—Å–∏–∫–∞' }
                });
            }
        });

        window.dispatchEvent(new Event('firebaseLoaded'));
    </script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #f8f6f2;
            --white: #ffffff;
            --black: #1a1208;
            --gray: #7a7060;
            --light: #e8e2d8;
            --accent: #c9a84c;
            --accent2: #8b6914;
            --red: #c0392b;
            --green: #27ae60;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--black);
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
        }

        /* ========== LOADING ========== */
        #loading {
            position: fixed;
            inset: 0;
            background: var(--white);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            gap: 16px;
        }

        #loading .logo-load {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: 4px;
            color: var(--black);
        }

        .spinner {
            width: 36px;
            height: 36px;
            border: 2px solid var(--light);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ========== CATALOG ========== */
        #catalog { display: none; }
        #catalog.active { display: block; }

        .header {
            background: var(--white);
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--light);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Admin tugmasi ‚Äî faqat uchta nuqta */
        .admin-trigger {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            border-radius: 6px;
            transition: background 0.2s;
            padding: 4px;
        }
        .admin-trigger:hover { background: var(--bg); }
        .admin-trigger span {
            display: block;
            width: 4px;
            height: 4px;
            background: var(--gray);
            border-radius: 50%;
        }

        .logo {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.6rem;
            font-weight: 700;
            letter-spacing: 3px;
            color: var(--black);
        }

        .lang {
            display: flex;
            gap: 3px;
            background: var(--bg);
            border-radius: 20px;
            padding: 3px;
        }

        .lang-btn {
            padding: 5px 12px;
            border: none;
            background: transparent;
            border-radius: 16px;
            font-size: 0.78rem;
            font-weight: 500;
            color: var(--gray);
            cursor: pointer;
            transition: 0.2s;
            font-family: 'DM Sans', sans-serif;
        }

        .lang-btn.active {
            background: var(--white);
            color: var(--black);
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }

        .search-wrap {
            padding: 12px 16px;
            background: var(--white);
            border-bottom: 1px solid var(--light);
        }

        .search-input {
            width: 100%;
            padding: 10px 14px 10px 36px;
            border: 1px solid var(--light);
            border-radius: 10px;
            font-size: 0.88rem;
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%237a7060' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.099zm-5.44 1.157a5.5 5.5 0 1 1 0-11 5.5 5.5 0 0 1 0 11z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 12px center;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            background-color: var(--white);
        }

        .cats {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            overflow-x: auto;
            scrollbar-width: none;
            background: var(--white);
            border-bottom: 1px solid var(--light);
        }
        .cats::-webkit-scrollbar { display: none; }

        .cat-btn {
            padding: 7px 16px;
            border: 1px solid var(--light);
            background: var(--white);
            border-radius: 20px;
            font-size: 0.82rem;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
            transition: 0.2s;
            font-family: 'DM Sans', sans-serif;
            color: var(--gray);
        }

        .cat-btn.active {
            background: var(--black);
            color: var(--white);
            border-color: var(--black);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 14px;
            padding-bottom: 30px;
        }

        .card {
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 1px 6px rgba(0,0,0,0.06);
        }

        .card:active { transform: scale(0.97); }

        .card-img {
            width: 100%;
            aspect-ratio: 3/4;
            background: linear-gradient(135deg, #f0ede8, #e0dbd2);
            position: relative;
            overflow: hidden;
        }

        .card-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .card:hover .card-img img { transform: scale(1.03); }

        .card-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }

        .card-info {
            padding: 10px 12px 12px;
        }

        .card-code {
            font-size: 0.68rem;
            color: var(--gray);
            font-weight: 500;
            letter-spacing: 0.5px;
            margin-bottom: 3px;
            text-transform: uppercase;
        }

        .card-name {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 2px;
            line-height: 1.2;
        }

        .card-material {
            font-size: 0.76rem;
            color: var(--gray);
        }

        /* ========== MODAL ========== */
        .modal {
            position: fixed;
            inset: 0;
            z-index: 500;
            display: none;
        }

        .modal.active { display: block; }

        .modal-bg {
            position: absolute;
            inset: 0;
            background: rgba(26,18,8,0.55);
            backdrop-filter: blur(2px);
        }

        .modal-sheet {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 20px 20px 0 0;
            max-height: 92vh;
            overflow-y: auto;
            animation: slideUp 0.3s cubic-bezier(0.32, 0.72, 0, 1);
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-handle {
            width: 36px;
            height: 3px;
            background: var(--light);
            border-radius: 2px;
            margin: 10px auto 0;
        }

        .modal-close {
            position: absolute;
            top: 12px;
            right: 14px;
            width: 30px;
            height: 30px;
            border: none;
            background: var(--bg);
            border-radius: 50%;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray);
        }

        .detail-img {
            width: 100%;
            height: 320px;
            background: linear-gradient(135deg, #f0ede8, #e0dbd2);
            position: relative;
            overflow: hidden;
        }

        .detail-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .detail-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
        }

        .detail-body {
            padding: 18px 20px 40px;
        }

        .detail-code {
            display: inline-block;
            background: var(--accent);
            color: var(--white);
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.72rem;
            font-weight: 600;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        .detail-name {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 6px;
            line-height: 1.1;
        }

        .detail-material {
            color: var(--gray);
            margin-bottom: 12px;
            font-size: 0.88rem;
        }

        .detail-desc {
            line-height: 1.65;
            color: var(--gray);
            margin-bottom: 18px;
            font-size: 0.9rem;
        }

        .detail-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .action-btn {
            flex: 1;
            padding: 11px;
            border: 1px solid var(--light);
            background: var(--white);
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: 0.2s;
            font-size: 0.88rem;
            font-family: 'DM Sans', sans-serif;
        }

        .action-btn:active { transform: scale(0.96); }

        .action-btn.liked {
            background: #fef2f2;
            border-color: var(--red);
            color: var(--red);
        }

        .detail-section {
            background: var(--bg);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .section-label {
            font-size: 0.72rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            color: var(--gray);
        }

        .sizes {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .size-tag {
            padding: 7px 14px;
            border: 1px solid var(--light);
            background: var(--white);
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .empty {
            grid-column: 1/-1;
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        /* ========== ADMIN ========== */
        #admin { display: none; }
        #admin.active { display: block; }

        .admin-header {
            background: var(--black);
            color: var(--white);
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .admin-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .back-btn {
            border: 1px solid rgba(255,255,255,0.3);
            background: transparent;
            color: var(--white);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.82rem;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            transition: background 0.2s;
        }
        .back-btn:hover { background: rgba(255,255,255,0.1); }

        .admin-nav {
            display: flex;
            background: var(--white);
            border-bottom: 1px solid var(--light);
            overflow-x: auto;
            scrollbar-width: none;
        }
        .admin-nav::-webkit-scrollbar { display: none; }

        .admin-nav-btn {
            padding: 13px 16px;
            border: none;
            background: transparent;
            font-size: 0.82rem;
            font-weight: 500;
            color: var(--gray);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            transition: 0.2s;
            font-family: 'DM Sans', sans-serif;
        }

        .admin-nav-btn.active {
            color: var(--black);
            border-bottom-color: var(--accent);
        }

        .admin-content {
            padding: 16px;
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 40px;
        }

        .admin-tab { display: none; }
        .admin-tab.active { display: block; }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 18px;
        }

        .stat-box {
            background: var(--white);
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }

        .stat-num {
            font-size: 1.8rem;
            font-weight: 700;
            font-family: 'Cormorant Garamond', serif;
            color: var(--accent2);
        }

        .stat-lbl {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 2px;
        }

        .card-white {
            background: var(--white);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            margin-bottom: 16px;
        }

        .card-white h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 14px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .form-group { margin-bottom: 12px; }

        .form-label {
            display: block;
            font-size: 0.82rem;
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--gray);
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--light);
            border-radius: 8px;
            font-size: 0.88rem;
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--white);
        }

        textarea.form-input {
            min-height: 78px;
            resize: vertical;
        }

        select.form-input { cursor: pointer; }

        .upload-box {
            border: 2px dashed var(--light);
            border-radius: 10px;
            padding: 26px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            background: var(--bg);
            font-size: 0.88rem;
            color: var(--gray);
        }

        .upload-box:hover {
            border-color: var(--accent);
            background: #fdf8ee;
        }

        .upload-box input { display: none; }

        .upload-preview {
            max-width: 160px;
            max-height: 160px;
            margin: 10px auto 0;
            border-radius: 8px;
            display: block;
        }

        .btn {
            padding: 11px 18px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            font-family: 'DM Sans', sans-serif;
        }

        .btn-black { background: var(--black); color: var(--white); }
        .btn-black:hover { background: #333; }
        .btn-full { width: 100%; }
        .btn-sm { padding: 6px 12px; font-size: 0.78rem; }
        .btn-red { background: var(--red); color: var(--white); }
        .btn-green { background: var(--green); color: var(--white); }

        .product-row {
            background: var(--white);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            gap: 12px;
            align-items: center;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }

        .product-thumb {
            width: 56px;
            height: 56px;
            border-radius: 8px;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            flex-shrink: 0;
            overflow: hidden;
        }

        .product-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-meta { flex: 1; min-width: 0; }
        .product-meta-code { font-size: 0.72rem; color: var(--gray); margin-bottom: 2px; }
        .product-meta-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .product-meta-cat { font-size: 0.78rem; color: var(--gray); }

        .product-actions { display: flex; gap: 6px; flex-shrink: 0; }

        /* ========== TOAST ========== */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(120px);
            background: var(--black);
            color: var(--white);
            padding: 11px 22px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.88rem;
            z-index: 9999;
            transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
            white-space: nowrap;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* ========== EDIT MODAL ========== */
        .modal-sheet-inner {
            padding: 20px;
            padding-bottom: 40px;
        }

        .modal-sheet-inner h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        hr.divider {
            border: none;
            border-top: 1px solid var(--light);
            margin: 16px 0;
        }

        @media (max-width: 480px) {
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- LOADING -->
<div id="loading">
    <div class="logo-load">NINA</div>
    <div class="spinner"></div>
</div>

<!-- CATALOG -->
<div id="catalog">
    <div class="header">
        <div class="header-left">
            <!-- Admin trigger: 3 nuqta (foydalanuvchilar sezmaydi) -->
            <button class="admin-trigger" id="adminTrigger" title="">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="logo">NINA</div>
        </div>
        <div class="lang" id="catalogLang">
            <button class="lang-btn active" data-lang="uz">O'z</button>
            <button class="lang-btn" data-lang="ru">–†—É</button>
        </div>
    </div>

    <div class="search-wrap">
        <input class="search-input" id="searchInput" placeholder="Qidirish...">
    </div>

    <div class="cats" id="catsBar"></div>

    <div class="grid" id="productsGrid"></div>
</div>

<!-- ADMIN -->
<div id="admin">
    <div class="admin-header">
        <div class="admin-title">NINA ADMIN</div>
        <button class="back-btn" onclick="showCatalog()">‚Üê Orqaga</button>
    </div>

    <div class="admin-nav">
        <button class="admin-nav-btn active" data-tab="dashboard">üìä Dashboard</button>
        <button class="admin-nav-btn" data-tab="add">‚ûï Qo'shish</button>
        <button class="admin-nav-btn" data-tab="list">üìã Ro'yxat</button>
        <button class="admin-nav-btn" data-tab="stats">üìà Statistika</button>
        <button class="admin-nav-btn" data-tab="cats">üè∑Ô∏è Kategoriyalar</button>
    </div>

    <div class="admin-content">

        <!-- DASHBOARD -->
        <div class="admin-tab active" id="tab-dashboard">
            <div class="stat-grid">
                <div class="stat-box">
                    <div class="stat-num" id="a-total">0</div>
                    <div class="stat-lbl">Mahsulotlar</div>
                </div>
                <div class="stat-box">
                    <div class="stat-num" id="a-views">0</div>
                    <div class="stat-lbl">Ko'rishlar</div>
                </div>
                <div class="stat-box">
                    <div class="stat-num" id="a-likes">0</div>
                    <div class="stat-lbl">Like'lar</div>
                </div>
                <div class="stat-box">
                    <div class="stat-num" id="a-cats">0</div>
                    <div class="stat-lbl">Kategoriyalar</div>
                </div>
            </div>
            <div class="card-white">
                <h3>üèÜ Top mahsulotlar</h3>
                <div id="a-top"></div>
            </div>
        </div>

        <!-- ADD PRODUCT -->
        <div class="admin-tab" id="tab-add">
            <div class="card-white">
                <h3>‚ûï Yangi mahsulot</h3>
                <form id="addForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Kod *</label>
                            <input class="form-input" name="code" placeholder="ST-001" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Kategoriya (ixtiyoriy)</label>
                            <select class="form-input" name="category" id="catSelect"></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nomi (UZ) *</label>
                            <input class="form-input" name="name_uz" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ (RU) *</label>
                            <input class="form-input" name="name_ru" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Material (UZ) *</label>
                            <input class="form-input" name="material_uz" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ú–∞—Ç–µ—Ä–∏–∞–ª (RU) *</label>
                            <input class="form-input" name="material_ru" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tavsif (UZ) *</label>
                        <textarea class="form-input" name="desc_uz" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (RU) *</label>
                        <textarea class="form-input" name="desc_ru" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">O'lchamlar (ixtiyoriy)</label>
                        <input class="form-input" name="sizes" placeholder="42,44,46 yoki S,M,L,XL">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Rasm yuklash (ixtiyoriy)</label>
                        <div class="upload-box" id="uploadBox" onclick="document.getElementById('imageUpload').click()">
                            <input type="file" id="imageUpload" accept="image/*" capture="environment">
                            <div id="uploadHint">üì∑ Galereyadan tanlang yoki bosing</div>
                            <div id="uploadProgress" style="display:none; margin-top:10px;">
                                <div style="height:4px; background:var(--light); border-radius:2px; overflow:hidden;">
                                    <div id="progressBar" style="height:100%; width:0%; background:var(--accent); transition:width 0.3s; border-radius:2px;"></div>
                                </div>
                                <div id="progressText" style="font-size:0.78rem; color:var(--gray); margin-top:6px; text-align:center;">Yuklanmoqda...</div>
                            </div>
                            <img id="imagePreview" class="upload-preview" style="display:none">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-black btn-full">üíæ Saqlash</button>
                </form>
            </div>
        </div>

        <!-- LIST -->
        <div class="admin-tab" id="tab-list">
            <div id="productsList"></div>
        </div>

        <!-- STATS -->
        <div class="admin-tab" id="tab-stats">
            <div class="card-white">
                <h3>üìà Ko'rishlar statistikasi</h3>
                <div id="statsContent"></div>
            </div>
        </div>

        <!-- CATEGORIES -->
        <div class="admin-tab" id="tab-cats">
            <div class="card-white">
                <h3>üè∑Ô∏è Mavjud kategoriyalar</h3>
                <div id="categoriesList"></div>
                <hr class="divider">
                <h3 style="font-size:0.95rem; margin-bottom:12px;">‚ûï Yangi kategoriya</h3>
                <form id="addCatForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nom (UZ)</label>
                            <input class="form-input" name="name_uz" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ (RU)</label>
                            <input class="form-input" name="name_ru" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-black btn-full">Qo'shish</button>
                </form>
            </div>
        </div>

    </div>
</div>

<!-- PRODUCT DETAIL MODAL -->
<div class="modal" id="modal">
    <div class="modal-bg" onclick="closeModal()"></div>
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <button class="modal-close" onclick="closeModal()">‚úï</button>
        <div id="modalContent"></div>
    </div>
</div>

<!-- EDIT MODAL -->
<div class="modal" id="editModal">
    <div class="modal-bg" onclick="closeEditModal()"></div>
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <button class="modal-close" onclick="closeEditModal()">‚úï</button>
        <div class="modal-sheet-inner">
            <h3>‚úèÔ∏è Tahrirlash</h3>
            <form id="editForm"></form>
        </div>
    </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- PAROL MODAL -->
<div class="modal" id="passModal">
    <div class="modal-bg" onclick="closePassModal()"></div>
    <div class="modal-sheet" style="border-radius:20px 20px 0 0; padding:28px 24px 40px;">
        <div class="modal-handle"></div>
        <h3 style="font-size:1.1rem; font-weight:600; margin-bottom:6px;">üîê Admin kirish</h3>
        <p style="color:var(--gray); font-size:0.85rem; margin-bottom:18px;">Admin parolini kiriting</p>
        <input class="form-input" id="passInput" type="password" placeholder="Parol..." style="margin-bottom:12px;">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-black" style="flex:1;" onclick="checkAdminPass()">Kirish</button>
            <button class="btn" style="flex:1; border:1px solid var(--light);" onclick="closePassModal()">Bekor</button>
        </div>
    </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal" id="confirmModal">
    <div class="modal-bg" onclick="closeConfirm()"></div>
    <div class="modal-sheet" style="border-radius:20px 20px 0 0; padding:28px 24px 40px;">
        <div class="modal-handle"></div>
        <p id="confirmText" style="font-size:1rem; font-weight:500; margin-bottom:20px; text-align:center;">O'chirasizmi?</p>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-red" style="flex:1;" id="confirmYes">Ha, o'chirish</button>
            <button class="btn" style="flex:1; border:1px solid var(--light);" onclick="closeConfirm()">Bekor</button>
        </div>
    </div>
</div>

<script>
// ============================================================
// TELEGRAM
// ============================================================
const tg = window.Telegram?.WebApp;
if (tg) {
    tg.ready();
    tg.expand();
    try { tg.setHeaderColor('#f8f6f2'); } catch(e) {}
}

// ============================================================
// CUSTOM MODAL HELPERS (prompt/confirm o'rniga)
// ============================================================
let _confirmCallback = null;

function showPassModal() {
    document.getElementById('passInput').value = '';
    document.getElementById('passModal').classList.add('active');
    setTimeout(() => document.getElementById('passInput').focus(), 300);
}

function closePassModal() {
    document.getElementById('passModal').classList.remove('active');
}

function checkAdminPass() {
    const val = document.getElementById('passInput').value;
    closePassModal();
    if (val === ADMIN_PASS) {
        showAdmin();
    } else {
        showToast("‚ùå Parol noto'g'ri!");
    }
}

document.getElementById('passInput')?.addEventListener('keydown', e => {
    if (e.key === 'Enter') checkAdminPass();
});

function showConfirm(text, callback) {
    document.getElementById('confirmText').textContent = text;
    _confirmCallback = callback;
    document.getElementById('confirmModal').classList.add('active');
}

function closeConfirm() {
    document.getElementById('confirmModal').classList.remove('active');
    _confirmCallback = null;
}

document.getElementById('confirmYes')?.addEventListener('click', () => {
    closeConfirm();
    if (_confirmCallback) _confirmCallback();
});

// ============================================================
// STATE
// ============================================================
const ADMIN_PASS = 'nina2026';
let currentLang = 'uz';
let allProducts = {};
let allCategories = {};
let currentCat = 'all';

const texts = {
    uz: { search: 'Qidirish...', all: 'Barchasi', noResult: 'Hech narsa topilmadi' },
    ru: { search: '–ü–æ–∏—Å–∫...', all: '–í—Å–µ', noResult: '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' }
};

// ============================================================
// FIREBASE HELPER
// ============================================================
function wait(cb) {
    if (window.firebaseReady) cb();
    else window.addEventListener('firebaseLoaded', cb, { once: true });
}

// ============================================================
// LOAD DATA
// ============================================================
function loadData() {
    wait(() => {
        window.dbOnValue(window.dbRef(window.db, 'products'), snap => {
            allProducts = snap.val() || {};
            renderProducts();
            if (document.getElementById('admin').classList.contains('active')) {
                updateAdminDashboard();
                renderProductsList();
                renderStats();
            }
        });

        window.dbOnValue(window.dbRef(window.db, 'categories'), snap => {
            allCategories = snap.val() || {};
            renderCats();
            updateCatSelect();
            renderCategoriesList();
        });
    });
}

// ============================================================
// RENDER CATALOG
// ============================================================
function renderCats() {
    const bar = document.getElementById('catsBar');
    if (!bar) return;
    const lang = currentLang;
    bar.innerHTML = `<button class="cat-btn ${currentCat === 'all' ? 'active' : ''}" data-cat="all">${texts[lang].all}</button>` +
        Object.keys(allCategories).map(k =>
            `<button class="cat-btn ${currentCat === k ? 'active' : ''}" data-cat="${k}">${lang === 'uz' ? allCategories[k].name_uz : allCategories[k].name_ru}</button>`
        ).join('');

    bar.querySelectorAll('.cat-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            currentCat = btn.dataset.cat;
            bar.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderProducts();
        });
    });
}

function renderProducts() {
    const search = (document.getElementById('searchInput')?.value || '').toLowerCase().trim();
    const grid = document.getElementById('productsGrid');
    if (!grid) return;

    const filtered = Object.values(allProducts).filter(p => {
        const matchCat = currentCat === 'all' || p.category === currentCat;
        const matchSearch = !search ||
            (p.code || '').toLowerCase().includes(search) ||
            (p.name_uz || '').toLowerCase().includes(search) ||
            (p.name_ru || '').toLowerCase().includes(search);
        return matchCat && matchSearch;
    });

    if (filtered.length === 0) {
        grid.innerHTML = `<div class="empty"><div style="font-size:3rem;margin-bottom:10px;">üîç</div><div>${texts[currentLang].noResult}</div></div>`;
        return;
    }

    grid.innerHTML = filtered.map(p => {
        const safeCode = (p.code || '').replace(/[^a-zA-Z0-9]/g, '');
        return `
        <div class="card" onclick="openProduct('${safeCode}')">
            <div class="card-img">
                ${p.image
                    ? `<img src="${p.image}" loading="lazy">`
                    : '<div class="card-placeholder">üëó</div>'}
            </div>
            <div class="card-info">
                <div class="card-code">${p.code || ''}</div>
                <div class="card-name">${currentLang === 'uz' ? (p.name_uz || '') : (p.name_ru || '')}</div>
                <div class="card-material">${currentLang === 'uz' ? (p.material_uz || '') : (p.material_ru || '')}</div>
            </div>
        </div>`;
    }).join('');
}

// ============================================================
// PRODUCT DETAIL
// ============================================================
function openProduct(safeCode) {
    const p = Object.values(allProducts).find(pr =>
        (pr.code || '').replace(/[^a-zA-Z0-9]/g, '') === safeCode
    );
    if (!p) return;

    const prodKey = Object.keys(allProducts).find(k => allProducts[k].code === p.code);

    // Ko'rishni oshir
    wait(() => {
        window.dbUpdate(window.dbRef(window.db, `products/${prodKey}`), {
            views: window.dbIncrement(1)
        });
    });

    const userLiked = localStorage.getItem(`liked_${prodKey}`) === 'true';
    const lang = currentLang;

    document.getElementById('modalContent').innerHTML = `
        <div class="detail-img">
            ${p.image
                ? `<img src="${p.image}">`
                : '<div class="detail-placeholder">üëó</div>'}
        </div>
        <div class="detail-body">
            <span class="detail-code">${p.code || ''}</span>
            <div class="detail-name">${lang === 'uz' ? (p.name_uz || '') : (p.name_ru || '')}</div>
            <div class="detail-material">üßµ ${lang === 'uz' ? (p.material_uz || '') : (p.material_ru || '')}</div>
            <div class="detail-desc">${lang === 'uz' ? (p.desc_uz || '') : (p.desc_ru || '')}</div>
            <div class="detail-actions">
                <button class="action-btn ${userLiked ? 'liked' : ''}" id="likeBtn_${prodKey}" onclick="toggleLike('${prodKey}', this)">
                    <span id="likeIcon_${prodKey}">${userLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                    <span id="likeCount_${prodKey}">${p.likes || 0}</span>
                </button>
                <button class="action-btn" onclick="shareProduct('${p.code}')">
                    <span>üì§</span>
                    <span>Ulashish</span>
                </button>
            </div>
            ${p.sizes
                ? `<div class="detail-section">
                    <div class="section-label">O'LCHAMLAR / –†–ê–ó–ú–ï–†–´</div>
                    <div class="sizes">${p.sizes.split(',').map(s => `<div class="size-tag">${s.trim()}</div>`).join('')}</div>
                   </div>`
                : ''}
        </div>`;

    document.getElementById('modal').classList.add('active');
    tg?.HapticFeedback?.impactOccurred('medium');
}

// ============================================================
// TOGGLE LIKE ‚Äî event argument xavfli emas, btn to'g'ridan uzatiladi
// ============================================================
function toggleLike(prodKey, btn) {
    const liked = localStorage.getItem(`liked_${prodKey}`) === 'true';
    const newLiked = !liked;

    localStorage.setItem(`liked_${prodKey}`, newLiked);

    wait(() => {
        window.dbUpdate(window.dbRef(window.db, `products/${prodKey}`), {
            likes: window.dbIncrement(newLiked ? 1 : -1)
        });
    });

    btn.classList.toggle('liked', newLiked);
    document.getElementById(`likeIcon_${prodKey}`).textContent = newLiked ? '‚ù§Ô∏è' : 'ü§ç';

    const countEl = document.getElementById(`likeCount_${prodKey}`);
    if (countEl) {
        const cur = parseInt(countEl.textContent) || 0;
        countEl.textContent = cur + (newLiked ? 1 : -1);
    }

    tg?.HapticFeedback?.impactOccurred('light');
}

function shareProduct(code) {
    const safeCode = (code || '').replace(/[^a-zA-Z0-9]/g, '');
    // GitHub Pages yoki hosting URL - .env dan olish yoki manual belgilash
    const baseUrl = window.NINA_BASE_URL || window.location.href.split('?')[0];
    const url = baseUrl + '?product=' + safeCode;
    
    if (tg && tg.openTelegramLink) {
        // Telegram orqali ulashish - tg://msg_url
        try {
            tg.openTelegramLink('https://t.me/share/url?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent('Nina Fashion: ' + code));
        } catch(e) {
            copyToClipboard(url);
        }
    } else if (navigator.share) {
        navigator.share({ title: 'Nina Fashion ‚Äî ' + code, url }).catch(() => copyToClipboard(url));
    } else {
        copyToClipboard(url);
    }
}

function copyToClipboard(text) {
    if (navigator.clipboard?.writeText) {
        navigator.clipboard.writeText(text).then(() => showToast('üìã Havola nusxalandi!'));
    } else {
        // Eski usul ‚Äî Telegram WebApp da ishlaydi
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.cssText = 'position:fixed;opacity:0;';
        document.body.appendChild(ta);
        ta.focus(); ta.select();
        try { document.execCommand('copy'); showToast('üìã Havola nusxalandi!'); } catch(e) { showToast('üîó ' + text); }
        document.body.removeChild(ta);
    }
}

function closeModal() {
    document.getElementById('modal').classList.remove('active');
}

// ============================================================
// LANG SWITCH
// ============================================================
function setupLangButtons(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            currentLang = btn.dataset.lang;
            // Ikki paneldagi lang tugmalarini sinxron qil
            document.querySelectorAll('.lang-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.lang === currentLang);
            });
            document.getElementById('searchInput').placeholder = texts[currentLang].search;
            renderCats();
            renderProducts();
        });
    });
}

setupLangButtons('catalogLang');

// ============================================================
// SEARCH
// ============================================================
let searchTimer;
document.getElementById('searchInput')?.addEventListener('input', () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(renderProducts, 280);
});

// ============================================================
// ADMIN KIRISH ‚Äî 3 nuqtani bosish
// ============================================================
document.getElementById('adminTrigger')?.addEventListener('click', () => {
    showPassModal();
});

function showAdmin() {
    document.getElementById('catalog').classList.remove('active');
    document.getElementById('admin').classList.add('active');
    updateAdminDashboard();
    renderProductsList();
    renderStats();
    renderCategoriesList();
}

function showCatalog() {
    document.getElementById('admin').classList.remove('active');
    document.getElementById('catalog').classList.add('active');
}

// ============================================================
// ADMIN NAV
// ============================================================
document.querySelectorAll('.admin-nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');

        if (tab === 'list') renderProductsList();
        if (tab === 'stats') renderStats();
        if (tab === 'cats') renderCategoriesList();
        if (tab === 'dashboard') updateAdminDashboard();
    });
});

// ============================================================
// CATEGORY SELECT (add form)
// ============================================================
function updateCatSelect() {
    const sel = document.getElementById('catSelect');
    if (!sel) return;
    sel.innerHTML = '<option value="">‚Äî Kategoriyasiz ‚Äî</option>' +
        Object.keys(allCategories).map(k =>
            '<option value="' + k + '">' + allCategories[k].name_uz + '</option>'
        ).join('');
}

// ============================================================
// DASHBOARD
// ============================================================
function updateAdminDashboard() {
    const prods = Object.values(allProducts);
    const totalViews = prods.reduce((s, p) => s + (p.views || 0), 0);
    const totalLikes = prods.reduce((s, p) => s + (p.likes || 0), 0);

    document.getElementById('a-total').textContent = prods.length;
    document.getElementById('a-views').textContent = totalViews;
    document.getElementById('a-likes').textContent = totalLikes;
    document.getElementById('a-cats').textContent = Object.keys(allCategories).length;

    const top3 = [...prods].sort((a, b) => (b.views || 0) - (a.views || 0)).slice(0, 3);
    document.getElementById('a-top').innerHTML = top3.length
        ? top3.map(p => `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--bg);border-radius:8px;margin-bottom:8px;">
                <span><strong>${p.code}</strong> ‚Äî ${p.name_uz}</span>
                <span style="color:var(--gray);font-size:0.82rem;">üëÅ ${p.views || 0} &nbsp;‚ù§Ô∏è ${p.likes || 0}</span>
            </div>`).join('')
        : '<div style="color:var(--gray);font-size:0.88rem;">Hozircha ma\'lumot yo\'q</div>';
}

// ============================================================
// IMAGE UPLOAD PREVIEW
// ============================================================
document.getElementById('imageUpload')?.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    
    // Fayl hajmini tekshir (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
        showToast('‚ùå Rasm 5MB dan kichik bo'lsin!');
        e.target.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = ev => {
        const preview = document.getElementById('imagePreview');
        preview.src = ev.target.result;
        preview.style.display = 'block';
        document.getElementById('uploadHint').textContent = '‚úÖ ' + file.name;
    };
    reader.readAsDataURL(file);
});

// ============================================================
// CLOUDINARY IMAGE UPLOAD
// ============================================================
async function uploadToCloudinary(file) {
    // Progress ko'rsatish
    const progressWrap = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    progressWrap.style.display = 'block';
    progressBar.style.width = '10%';
    progressText.textContent = 'Rasm tayyorlanmoqda...';
    
    // Rasmni kichraytirish (telefon uchun)
    const resized = await resizeImage(file, 1200);
    
    progressBar.style.width = '40%';
    progressText.textContent = 'Yuklanmoqda...';
    
    // Cloudinary unsigned upload (bepul, hech qanday API key kerak emas foydalanuvchi uchun)
    const cloudName = 'dxletfkqo'; // bepul demo cloud
    const uploadPreset = 'ml_default'; // unsigned preset
    
    const formData = new FormData();
    formData.append('file', resized);
    formData.append('upload_preset', uploadPreset);
    formData.append('folder', 'nina-fashion');
    
    const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
        method: 'POST',
        body: formData
    });
    
    if (!response.ok) {
        // Cloudinary ishlamasa - base64 sifatida Firebase'ga saqlash
        progressText.textContent = 'Boshqa usul sinab ko'rilmoqda...';
        progressBar.style.width = '70%';
        return await saveAsBase64(resized);
    }
    
    const data = await response.json();
    progressBar.style.width = '100%';
    progressText.textContent = '‚úÖ Yuklandi!';
    setTimeout(() => { progressWrap.style.display = 'none'; }, 1500);
    
    return data.secure_url;
}

// Rasmni kichraytirish funksiyasi
function resizeImage(file, maxWidth) {
    return new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let w = img.width, h = img.height;
                if (w > maxWidth) { h = h * maxWidth / w; w = maxWidth; }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.85);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}

// Zaxira: base64 sifatida saqlash (rasm kichik bo'lsa)
function saveAsBase64(blob) {
    return new Promise((resolve, reject) => {
        if (blob.size > 500 * 1024) {
            reject(new Error('Rasm juda katta, URL kiriting'));
            return;
        }
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

// ============================================================
// ADD PRODUCT
// ============================================================
document.getElementById('addForm')?.addEventListener('submit', async e => {
    e.preventDefault();
    const btn = e.target.querySelector('button[type=submit]');
    btn.disabled = true;
    btn.textContent = 'Yuklanmoqda...';

    const fd = new FormData(e.target);
    const code = (fd.get('code') || '').trim().toUpperCase();
    const file = document.getElementById('imageUpload').files[0];

    let imageUrl = '';
    if (file) {
        // Cloudinary orqali yuklash - bepul, hech qanday sozlama kerak emas
        try {
            imageUrl = await uploadToCloudinary(file);
        } catch (err) {
            showToast('‚ùå Rasm yuklashda xatolik!');
            btn.disabled = false;
            btn.textContent = 'üíæ Saqlash';
            console.error('Upload error:', err);
            return;
        }
    }

    const newProduct = {
        code,
        name_uz: (fd.get('name_uz') || '').trim(),
        name_ru: (fd.get('name_ru') || '').trim(),
        material_uz: (fd.get('material_uz') || '').trim(),
        material_ru: (fd.get('material_ru') || '').trim(),
        desc_uz: (fd.get('desc_uz') || '').trim(),
        desc_ru: (fd.get('desc_ru') || '').trim(),
        category: fd.get('category') || 'umumiy',
        sizes: (fd.get('sizes') || '').trim(),
        image: imageUrl,
        views: 0,
        likes: 0,
        createdAt: Date.now()
    };

    wait(() => {
        const key = code.replace(/[^a-zA-Z0-9]/g, '');
        window.dbSet(window.dbRef(window.db, `products/${key}`), newProduct).then(() => {
            showToast('‚úÖ Mahsulot qo\'shildi!');
            e.target.reset();
            document.getElementById('imagePreview').style.display = 'none';
            btn.disabled = false;
            btn.textContent = 'üíæ Saqlash';
            tg?.HapticFeedback?.notificationOccurred('success');
        }).catch(() => {
            showToast('‚ùå Xatolik yuz berdi!');
            btn.disabled = false;
            btn.textContent = 'üíæ Saqlash';
        });
    });
});

// ============================================================
// PRODUCTS LIST (admin)
// ============================================================
function renderProductsList() {
    const list = document.getElementById('productsList');
    if (!list) return;
    const prods = Object.entries(allProducts);

    if (prods.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:var(--gray);padding:40px;">Mahsulotlar yo\'q</div>';
        return;
    }

    list.innerHTML = prods.map(([k, p]) => `
        <div class="product-row">
            <div class="product-thumb">
                ${p.image ? `<img src="${p.image}" loading="lazy">` : 'üëó'}
            </div>
            <div class="product-meta">
                <div class="product-meta-code">${p.code} &nbsp;¬∑&nbsp; üëÅ ${p.views || 0} &nbsp;‚ù§Ô∏è ${p.likes || 0}</div>
                <div class="product-meta-name">${p.name_uz}</div>
                <div class="product-meta-cat">${allCategories[p.category]?.name_uz || p.category}</div>
            </div>
            <div class="product-actions">
                <button class="btn btn-sm btn-green" onclick="editProduct('${k}')">‚úèÔ∏è</button>
                <button class="btn btn-sm btn-red" onclick="deleteProduct('${k}')">üóëÔ∏è</button>
            </div>
        </div>`).join('');
}

// ============================================================
// EDIT PRODUCT
// ============================================================
function editProduct(key) {
    const p = allProducts[key];
    if (!p) return;

    const catOptions = Object.keys(allCategories).map(k =>
        `<option value="${k}" ${p.category === k ? 'selected' : ''}>${allCategories[k].name_uz}</option>`
    ).join('');

    const editImgId = 'editImg_' + key;
    const editPrevId = 'editPrev_' + key;
    const editProgId = 'editProg_' + key;
    
    document.getElementById('editForm').innerHTML = `
        <div class="form-row">
            <div class="form-group"><label class="form-label">Kod</label><input class="form-input" name="code" value="${p.code || ''}" required></div>
            <div class="form-group"><label class="form-label">Kategoriya</label><select class="form-input" name="category">${catOptions}</select></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">Nomi (UZ)</label><input class="form-input" name="name_uz" value="${p.name_uz || ''}" required></div>
            <div class="form-group"><label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ (RU)</label><input class="form-input" name="name_ru" value="${p.name_ru || ''}" required></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">Material (UZ)</label><input class="form-input" name="material_uz" value="${p.material_uz || ''}" required></div>
            <div class="form-group"><label class="form-label">–ú–∞—Ç–µ—Ä–∏–∞–ª (RU)</label><input class="form-input" name="material_ru" value="${p.material_ru || ''}" required></div>
        </div>
        <div class="form-group"><label class="form-label">Tavsif (UZ)</label><textarea class="form-input" name="desc_uz" required>${p.desc_uz || ''}</textarea></div>
        <div class="form-group"><label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (RU)</label><textarea class="form-input" name="desc_ru" required>${p.desc_ru || ''}</textarea></div>
        <div class="form-group"><label class="form-label">O'lchamlar</label><input class="form-input" name="sizes" value="${p.sizes || ''}"></div>
        <div class="form-group">
            <label class="form-label">Rasm yangilash (ixtiyoriy)</label>
            <div class="upload-box" onclick="document.getElementById('${editImgId}').click()">
                <input type="file" id="${editImgId}" accept="image/*" capture="environment">
                <div id="${editImgId}_hint">üì∑ Yangi rasm tanlash</div>
                <div id="${editProgId}" style="display:none; margin-top:8px;">
                    <div style="height:4px;background:var(--light);border-radius:2px;overflow:hidden;">
                        <div id="${editProgId}_bar" style="height:100%;width:0%;background:var(--accent);transition:width 0.3s;border-radius:2px;"></div>
                    </div>
                    <div id="${editProgId}_text" style="font-size:0.78rem;color:var(--gray);margin-top:4px;text-align:center;">Yuklanmoqda...</div>
                </div>
                ${p.image ? `<img src="${p.image}" id="${editPrevId}" class="upload-preview" style="margin-top:8px;">` : `<img id="${editPrevId}" class="upload-preview" style="display:none;">`}
            </div>
        </div>
        <button type="submit" class="btn btn-black btn-full">üíæ Saqlash</button>`;
    
    // Edit rasm preview
    document.getElementById(editImgId)?.addEventListener('change', ev => {
        const f = ev.target.files[0];
        if (!f) return;
        const r = new FileReader();
        r.onload = re => {
            const prev = document.getElementById(editPrevId);
            prev.src = re.target.result;
            prev.style.display = 'block';
            document.getElementById(editImgId + '_hint').textContent = '‚úÖ ' + f.name;
        };
        r.readAsDataURL(f);
    });

    document.getElementById('editForm').onsubmit = async e => {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type=submit]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saqlanmoqda...';

        const fd = new FormData(e.target);
        const updated = {
            code: (fd.get('code') || '').trim(),
            name_uz: (fd.get('name_uz') || '').trim(),
            name_ru: (fd.get('name_ru') || '').trim(),
            material_uz: (fd.get('material_uz') || '').trim(),
            material_ru: (fd.get('material_ru') || '').trim(),
            desc_uz: (fd.get('desc_uz') || '').trim(),
            desc_ru: (fd.get('desc_ru') || '').trim(),
            category: fd.get('category') || 'umumiy',
            sizes: (fd.get('sizes') || '').trim()
        };

        // Yangi rasm tanlangan bolsa yuklash
        const editImgInput = document.getElementById('editImg_' + key);
        const newFile = editImgInput && editImgInput.files[0];
        if (newFile) {
            try {
                showToast('üì§ Rasm yuklanmoqda...');
                const newImageUrl = await uploadToCloudinary(newFile);
                updated.image = newImageUrl;
            } catch (err) {
                showToast('‚ùå Rasm yuklashda xatolik!');
                submitBtn.disabled = false;
                submitBtn.textContent = 'üíæ Saqlash';
                return;
            }
        }

        wait(() => {
            window.dbUpdate(window.dbRef(window.db, 'products/' + key), updated).then(() => {
                showToast('‚úÖ Yangilandi!');
                closeEditModal();
                submitBtn.disabled = false;
                submitBtn.textContent = 'üíæ Saqlash';
            }).catch(() => {
                showToast('‚ùå Xatolik!');
                submitBtn.disabled = false;
                submitBtn.textContent = 'üíæ Saqlash';
            });
        });
    };

    document.getElementById('editModal').classList.add('active');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('active');
}

// ============================================================
// DELETE PRODUCT
// ============================================================
function deleteProduct(key) {
    showConfirm("Mahsulotni o'chirasizmi?", () => {
        wait(() => {
            window.dbRemove(window.dbRef(window.db, `products/${key}`)).then(() => {
                showToast('üóëÔ∏è O\'chirildi!');
            }).catch(() => showToast('‚ùå Xatolik!'));
        });
    });
}

// ============================================================
// STATS
// ============================================================
function renderStats() {
    const prods = Object.values(allProducts);
    if (prods.length === 0) {
        document.getElementById('statsContent').innerHTML = '<div style="color:var(--gray);font-size:0.88rem;">Mahsulotlar yo\'q</div>';
        return;
    }
    const maxViews = Math.max(...prods.map(p => p.views || 0), 1);
    const sorted = [...prods].sort((a, b) => (b.views || 0) - (a.views || 0));

    document.getElementById('statsContent').innerHTML = sorted.map(p => `
        <div style="margin-bottom:14px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:0.88rem;">
                <span><strong>${p.code}</strong> ‚Äî ${p.name_uz}</span>
                <span style="color:var(--gray)">üëÅ ${p.views || 0} &nbsp;‚ù§Ô∏è ${p.likes || 0}</span>
            </div>
            <div style="height:5px;background:var(--light);border-radius:3px;overflow:hidden;">
                <div style="width:${((p.views || 0) / maxViews * 100).toFixed(1)}%;height:100%;background:var(--accent);border-radius:3px;transition:width 0.8s;"></div>
            </div>
        </div>`).join('');
}

// ============================================================
// CATEGORIES
// ============================================================
function renderCategoriesList() {
    const list = document.getElementById('categoriesList');
    if (!list) return;
    const cats = Object.entries(allCategories);

    if (cats.length === 0) {
        list.innerHTML = '<div style="color:var(--gray);font-size:0.88rem;">Kategoriyalar yo\'q</div>';
        return;
    }

    list.innerHTML = cats.map(([k, c]) => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--bg);border-radius:8px;margin-bottom:8px;">
            <div><strong>${c.name_uz}</strong> <span style="color:var(--gray)">/ ${c.name_ru}</span></div>
            <button class="btn btn-sm btn-red" onclick="deleteCat('${k}')">üóëÔ∏è</button>
        </div>`).join('');
}

document.getElementById('addCatForm')?.addEventListener('submit', e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const nameUz = (fd.get('name_uz') || '').trim();
    const nameRu = (fd.get('name_ru') || '').trim();
    if (!nameUz || !nameRu) return;

    // O'zbek harflari ham ishlashi uchun: avval lotin harflariga o'xshatib, keyin timestamp bilan kafolatlaymiz
    let key = nameUz
        .toLowerCase()
        .replace(/o'|o`/g, 'o')
        .replace(/g'|g`/g, 'g')
        .replace(/\s+/g, '_')
        .replace(/[^a-z0-9_]/g, '');

    // Agar key bo'sh qolsa ‚Äî timestamp ishlatamiz
    if (!key) key = 'cat_' + Date.now();

    wait(() => {
        window.dbSet(window.dbRef(window.db, `categories/${key}`), {
            name_uz: nameUz,
            name_ru: nameRu
        }).then(() => {
            showToast('‚úÖ Kategoriya qo\'shildi!');
            e.target.reset();
        }).catch(err => {
            console.error('Category add error:', err);
            showToast('‚ùå Xatolik! Firebase rules tekshiring.');
        });
    });
});

function deleteCat(key) {
    showConfirm("Kategoriyani o'chirasizmi?", () => {
        wait(() => {
            window.dbRemove(window.dbRef(window.db, `categories/${key}`)).then(() => {
                showToast('üóëÔ∏è O\'chirildi!');
            }).catch(() => showToast('‚ùå Xatolik!'));
        });
    });
}

// ============================================================
// TOAST
// ============================================================
function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2800);
}

// ============================================================
// INIT
// ============================================================
function init() {
    loadData();

    setTimeout(() => {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('catalog').classList.add('active');

        // Direct product link
        // URL params ‚Äî Telegram WebApp da ham ishlaydi
        let productCode = null;
        try {
            const params = new URLSearchParams(window.location.search);
            productCode = params.get('product');
            // Telegram initData ichidan ham olishga harakat
            if (!productCode && tg?.initDataUnsafe?.start_param) {
                productCode = tg.initDataUnsafe.start_param;
            }
        } catch(e) {}
        if (productCode) {
            setTimeout(() => openProduct(productCode), 600);
        }
    }, 900);
}

init();
</script>
</body>
</html>
